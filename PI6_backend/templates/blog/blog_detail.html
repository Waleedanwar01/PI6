{% extends 'base.html' %}
{% load blog_extras %}

{% block title %}{{ post.meta_title|default:post.title }} - {{ site_config.site_name }}{% endblock %}
{% block meta_description %}{{ post.meta_description|default:post.excerpt }}{% endblock %}

{% block content %}
<!-- Reading Progress Bar -->
<div class="fixed top-0 left-0 w-full h-1 z-50 bg-gray-200">
    <div id="readingProgress" class="h-full bg-[#ffcc00] width-0 transition-all duration-100"></div>
</div>

<article class="bg-white min-h-screen pb-16">
    <!-- Header Section -->
    <header class="bg-gray-50 pt-12 pb-12 border-b border-gray-100">
        <div class="container mx-auto px-4 max-w-4xl text-center">
            
            <!-- Category & Date -->
            <div class="flex items-center justify-center space-x-4 mb-6 text-sm font-medium">
                {% if post.category %}
                <a href="{% url 'blog_category_list' post.category.slug %}" class="bg-blue-100 text-brand-blue px-3 py-1 rounded-none hover:bg-blue-200 transition-colors">
                    {{ post.category.name }}
                </a>
                {% endif %}
                <span class="text-gray-500">{{ post.published_at|date:"F j, Y" }}</span>
            </div>

            <h1 class="text-3xl md:text-5xl font-bold text-gray-900 mb-6 leading-tight tracking-tight">{{ post.title }}</h1>
            
            {% if post.excerpt %}
            <div class="max-w-3xl mx-auto mb-10 px-6">
                <div class="relative text-center">
                    <svg class="w-8 h-8 text-yellow-400 absolute -top-4 left-0 opacity-40" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14.017 21L14.017 18C14.017 16.896 14.321 16.068 14.929 15.516C15.537 14.964 16.696 14.184 18.406 13.176L18.406 10.92C16.92 11.592 15.939 12.012 15.463 12.18C14.987 12.348 14.655 12.036 14.467 11.244C14.279 10.452 14.185 9.444 14.185 8.22C14.185 5.868 15.013 3.996 16.669 2.604C18.325 1.212 20.257 0.516 22.465 0.516L22.465 6.084C21.841 6.084 21.373 6.228 21.061 6.516C20.749 6.804 20.593 7.332 20.593 8.1C20.593 8.772 20.737 9.324 21.025 9.756C21.313 10.188 21.805 10.404 22.501 10.404L22.501 21L14.017 21ZM0.685 21L0.685 18C0.685 16.896 0.989 16.068 1.597 15.516C2.205 14.964 3.364 14.184 5.074 13.176L5.074 10.92C3.588 11.592 2.607 12.012 2.131 12.18C1.655 12.348 1.323 12.036 1.135 11.244C0.947 10.452 0.853 9.444 0.853 8.22C0.853 5.868 1.681 3.996 3.337 2.604C4.993 1.212 6.925 0.516 9.133 0.516L9.133 6.084C8.509 6.084 8.041 6.228 7.729 6.516C7.417 6.804 7.261 7.332 7.261 8.1C7.261 8.772 7.405 9.324 7.693 9.756C7.981 10.188 8.473 10.404 9.169 10.404L9.169 21L0.685 21Z"></path>
                    </svg>
                    <p class="text-xl md:text-2xl text-gray-500 italic font-medium leading-relaxed px-8 py-2 relative z-10">
                        {{ post.excerpt }}
                    </p>
                    <svg class="w-8 h-8 text-yellow-400 absolute -bottom-4 right-0 opacity-40 rotate-180" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14.017 21L14.017 18C14.017 16.896 14.321 16.068 14.929 15.516C15.537 14.964 16.696 14.184 18.406 13.176L18.406 10.92C16.92 11.592 15.939 12.012 15.463 12.18C14.987 12.348 14.655 12.036 14.467 11.244C14.279 10.452 14.185 9.444 14.185 8.22C14.185 5.868 15.013 3.996 16.669 2.604C18.325 1.212 20.257 0.516 22.465 0.516L22.465 6.084C21.841 6.084 21.373 6.228 21.061 6.516C20.749 6.804 20.593 7.332 20.593 8.1C20.593 8.772 20.737 9.324 21.025 9.756C21.313 10.188 21.805 10.404 22.501 10.404L22.501 21L14.017 21ZM0.685 21L0.685 18C0.685 16.896 0.989 16.068 1.597 15.516C2.205 14.964 3.364 14.184 5.074 13.176L5.074 10.92C3.588 11.592 2.607 12.012 2.131 12.18C1.655 12.348 1.323 12.036 1.135 11.244C0.947 10.452 0.853 9.444 0.853 8.22C0.853 5.868 1.681 3.996 3.337 2.604C4.993 1.212 6.925 0.516 9.133 0.516L9.133 6.084C8.509 6.084 8.041 6.228 7.729 6.516C7.417 6.804 7.261 7.332 7.261 8.1C7.261 8.772 7.405 9.324 7.693 9.756C7.981 10.188 8.473 10.404 9.169 10.404L9.169 21L0.685 21Z"></path>
                    </svg>
                </div>
            </div>
            {% endif %}

                <!-- Call to Action Button -->
                {% if post.button_text and post.button_url %}
                <div class="mt-8 text-center">
                    <a href="{{ post.button_url }}" class="inline-block bg-[#333333] text-white font-bold text-lg px-8 py-4 rounded-none shadow-lg hover:bg-[#ffcc00] hover:text-gray-900 transform hover:-translate-y-1 transition-all duration-300">
                        {{ post.button_text }}
                    </a>
                </div>
                {% endif %}

        </div>
    </header>

    <!-- Featured Image -->
    {% if post.featured_image %}
    <div class="container mx-auto px-4 max-w-3xl mt-8 mb-12">
        <div class="rounded-none overflow-hidden shadow-lg border border-gray-100 bg-gray-100">
            <img src="{{ post.featured_image.url }}" alt="{{ post.title }}" class="w-full h-auto max-h-[450px] object-cover mx-auto">
        </div>
    </div>
    {% endif %}

    <!-- Content & Sidebar Wrapper -->
    <div class="container mx-auto px-4 max-w-6xl">
        <div class="flex flex-col lg:flex-row gap-8 lg:gap-12">
            
            <!-- Content Column -->
            <div class="lg:w-3/4 order-1 lg:order-2">
                
                <div id="article-content" class="prose lg:prose-lg max-w-none prose-headings:font-bold prose-headings:text-gray-900 prose-p:text-gray-700 prose-a:text-brand-blue prose-a:no-underline hover:prose-a:underline prose-img:rounded-none">
                    {{ post.content|safe }}
                </div>

                <!-- Video Section -->
                {% if post.video_url or post.video_file %}
                <div class="mt-12 mb-8 bg-gray-50 rounded-none p-6 border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-brand-red" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Featured Video
                    </h3>
                    {% if post.video_file %}
                    <div class="rounded-none overflow-hidden shadow-lg bg-black">
                        <video controls class="w-full h-auto max-h-[600px] mx-auto">
                            <source src="{{ post.video_file.url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                    {% elif post.video_url %}
                    <div class="rounded-none overflow-hidden shadow-lg aspect-w-16 aspect-h-9">
                        <iframe src="{{ post.video_url }}" class="w-full h-full" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Share & Tags Footer -->
                <div class="mt-16 pt-8 border-t border-gray-100">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="text-gray-500 font-medium">
                            Share this article:
                        </div>
                        <div class="flex space-x-4">
                            <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="w-10 h-10 rounded-none bg-blue-600 text-white flex items-center justify-center hover:bg-blue-700 transition-colors">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"/></svg>
                            </a>
                            <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ post.title }}" target="_blank" class="w-10 h-10 rounded-none bg-sky-500 text-white flex items-center justify-center hover:bg-sky-600 transition-colors">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"/></svg>
                            </a>
                            <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.build_absolute_uri }}&title={{ post.title }}" target="_blank" class="w-10 h-10 rounded-none bg-blue-800 text-white flex items-center justify-center hover:bg-blue-900 transition-colors">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TOC Sidebar -->
            <aside class="w-full lg:w-1/4 order-2 lg:order-1 mt-8 lg:mt-0">
                <div class="lg:sticky lg:top-24 space-y-8">
                    <!-- TOC -->
                    <div id="toc-container" class="bg-gray-50 rounded-none p-6 border border-gray-100 hidden">
                        <h4 class="font-bold text-gray-900 mb-4 uppercase text-xs tracking-wider border-b border-gray-200 pb-2">On this page</h4>
                        <nav id="table-of-contents" class="space-y-1 text-sm max-h-[calc(50vh)] overflow-y-auto custom-scrollbar">
                            <!-- JS will populate this -->
                        </nav>
                    </div>

                    <!-- Gallery Widget -->
                    {% if post.gallery_images.exists %}
                    <div class="bg-white rounded-none shadow-sm border border-gray-100 overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-100">
                            <h4 class="font-bold text-gray-900 uppercase text-xs tracking-wider">Gallery</h4>
                        </div>
                        <div class="p-4 grid grid-cols-2 gap-2">
                            {% for img in post.gallery_images.all %}
                            <div class="cursor-pointer aspect-w-1 aspect-h-1 overflow-hidden rounded-none group relative" onclick="openLightbox('{{ img.image.url }}', '{{ img.caption|default:post.title|escapejs }}')">
                                <img src="{{ img.image.url }}" alt="{{ img.caption|default:post.title }}" class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-500">
                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity flex items-center justify-center">
                                    <svg class="w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </aside>

        </div>
    </div>
</article>

<!-- Related Posts -->
{% if related_posts %}
<section class="bg-gray-50 py-16">
    <div class="container mx-auto px-4 max-w-6xl">
        <h3 class="text-2xl font-bold text-gray-900 mb-8 text-center">Related Articles</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            {% for r_post in related_posts %}
            <article class="bg-white rounded-none shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden">
                {% if r_post.featured_image %}
                <a href="{% url 'blog_detail' r_post.slug %}" class="block h-48 overflow-hidden">
                    <img src="{{ r_post.featured_image.url }}" alt="{{ r_post.title }}" class="w-full h-full object-cover transform hover:scale-105 transition-transform duration-500">
                </a>
                {% else %}
                <a href="{% url 'blog_detail' r_post.slug %}" class="block h-48 overflow-hidden relative group">
                    <img src="{{ r_post.id|get_random_image }}" alt="{{ r_post.title }}" class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-500">
                    <div class="absolute inset-0 bg-brand-blue bg-opacity-10"></div>
                </a>
                {% endif %}
                <div class="p-5">
                    <h4 class="font-bold text-lg mb-2 line-clamp-2">
                        <a href="{% url 'blog_detail' r_post.slug %}" class="hover:text-brand-blue transition-colors">{{ r_post.title }}</a>
                    </h4>
                    <p class="text-gray-500 text-sm mb-0">{{ r_post.published_at|date:"M d, Y" }}</p>
                </div>
            </article>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Related Links List -->
{% if related_links %}
<section class="bg-white py-12 border-t border-gray-100">
    <div class="container mx-auto px-4 max-w-6xl">
        <h4 class="text-xl font-bold text-gray-900 mb-6">Explore More</h4>
        <ul class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-3">
            {% for link in related_links %}
            <li>
                <a href="{% url 'blog_detail' link.slug %}" class="flex items-start text-gray-600 hover:text-brand-blue transition-colors group">
                    <svg class="w-5 h-5 mr-2 text-gray-400 group-hover:text-brand-blue transition-colors mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                    <span class="group-hover:underline">{{ link.title }}</span>
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
</section>
{% endif %}

<!-- Lightbox Modal -->
<div id="lightbox" class="fixed inset-0 z-[100] hidden bg-black bg-opacity-95 flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
    <button onclick="closeLightbox()" class="absolute top-4 right-4 text-white hover:text-gray-300 focus:outline-none p-2">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
    </button>
    <div class="relative max-w-7xl w-full max-h-screen flex flex-col items-center">
        <img id="lightbox-img" src="" alt="" class="max-h-[85vh] max-w-full object-contain rounded-none shadow-2xl">
        <p id="lightbox-caption" class="text-white mt-4 text-center font-medium text-lg"></p>
    </div>
</div>

<!-- Page Scripts -->
<script>
    function openLightbox(src, caption) {
        const lightbox = document.getElementById('lightbox');
        const img = document.getElementById('lightbox-img');
        const cap = document.getElementById('lightbox-caption');
        
        img.src = src;
        cap.textContent = caption;
        
        lightbox.classList.remove('hidden');
        // Small delay to allow display:block to apply before opacity transition
        setTimeout(() => {
            lightbox.classList.remove('opacity-0');
        }, 10);
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        const lightbox = document.getElementById('lightbox');
        lightbox.classList.add('opacity-0');
        setTimeout(() => {
            lightbox.classList.add('hidden');
            document.getElementById('lightbox-img').src = '';
        }, 300);
        document.body.style.overflow = '';
    }

    // Close on background click
    document.getElementById('lightbox').addEventListener('click', function(e) {
        if (e.target === this) {
            closeLightbox();
        }
    });

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeLightbox();
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        // TOC Logic
        const content = document.getElementById('article-content');
        const tocContainer = document.getElementById('table-of-contents');
        const tocWrapper = document.getElementById('toc-container');
        
        if (content && tocContainer) {
            const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
            
            if (headings.length > 0) {
                if(tocWrapper) tocWrapper.classList.remove('hidden');

                headings.forEach((heading, index) => {
                    if (!heading.id) {
                        const slug = heading.textContent.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-');
                        heading.id = slug || `heading-${index}`;
                    }

                    const link = document.createElement('a');
                    link.href = '#' + heading.id;
                    link.textContent = heading.textContent;
                    
                    // Dynamic indentation based on heading level
                    const level = parseInt(heading.tagName.substring(1));
                    let paddingClass = 'pl-3';
                    if (level === 3) paddingClass = 'pl-6';
                    if (level === 4) paddingClass = 'pl-9';
                    if (level >= 5) paddingClass = 'pl-12';
                    
                    link.className = `block text-gray-500 hover:text-brand-blue transition-colors py-1.5 border-l-2 border-transparent hover:border-brand-blue ${paddingClass} text-sm`;
                    
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = document.getElementById(heading.id);
                        if (target) {
                            const headerOffset = 100;
                            const elementPosition = target.getBoundingClientRect().top;
                            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                            window.scrollTo({ top: offsetPosition, behavior: "smooth" });
                            
                            // Update active state
                            document.querySelectorAll('#table-of-contents a').forEach(a => {
                                a.classList.remove('text-brand-blue', 'border-brand-blue', 'font-medium');
                                a.classList.add('text-gray-500', 'border-transparent');
                            });
                            link.classList.remove('text-gray-500', 'border-transparent');
                            link.classList.add('text-brand-blue', 'border-brand-blue', 'font-medium');
                        }
                    });
                    tocContainer.appendChild(link);
                });
            } else {
                 if(tocWrapper) tocWrapper.style.display = 'none';
            }
        }
    });

    // Scroll Handler (Progress Bar + TOC Spy)
    window.addEventListener('scroll', function() {
        // Progress Bar
        var winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        var height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        var scrolled = (winScroll / height) * 100;
        var progressBar = document.getElementById("readingProgress");
        if(progressBar) progressBar.style.width = scrolled + "%";

        // TOC Spy
        const headings = document.querySelectorAll('#article-content h1, #article-content h2, #article-content h3, #article-content h4, #article-content h5, #article-content h6');
        let current = '';
        headings.forEach(heading => {
            const sectionTop = heading.offsetTop;
            if (window.scrollY >= sectionTop - 150) {
                current = heading.getAttribute('id');
            }
        });
        
        if(current) {
            document.querySelectorAll('#table-of-contents a').forEach(a => {
                a.classList.remove('text-brand-blue', 'border-brand-blue', 'font-medium');
                a.classList.add('text-gray-500', 'border-transparent');
                if (a.getAttribute('href').includes(current)) {
                    a.classList.remove('text-gray-500', 'border-transparent');
                    a.classList.add('text-brand-blue', 'border-brand-blue', 'font-medium');
                    
                    // Auto-scroll TOC container to keep active item in view
                    const tocContainer = document.getElementById('table-of-contents');
                    const linkTop = a.offsetTop;
                    const linkHeight = a.offsetHeight;
                    const containerHeight = tocContainer.clientHeight;
                    const containerScrollTop = tocContainer.scrollTop;

                    if (linkTop < containerScrollTop + 50 || linkTop > containerScrollTop + containerHeight - 50) {
                         tocContainer.scrollTo({
                            top: linkTop - containerHeight / 2 + linkHeight / 2,
                            behavior: 'smooth'
                        });
                    }
                }
            });
        }
    });
</script>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #ddd; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #ccc; }

    /* Mobile Responsive Fixes */
    #article-content table {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-collapse: collapse;
    }
    #article-content img,
    #article-content iframe,
    #article-content video {
        max-width: 100%;
        height: auto;
    }
    /* Ensure no horizontal scroll on mobile */
    body {
        overflow-x: hidden;
    }
</style>
{% endblock %}
